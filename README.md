
﻿# MPLX — Minimal Programming Language eXperiment

Небольшой язык с компиляцией в байткод и стековой VM (C++20), CLI, базовой IDE‑интеграцией (LSP/VS Code) и нативным C API для .NET.

## Описание проекта

MPLX представляет собой полноценный язык программирования, реализованный с использованием нескольких языков программирования для различных компонентов системы. Проект демонстрирует возможности создания комплексных developer tools с применением современных технологий.

### Возможности языка:
- Функции, переменные, циклы, условия
- Математические операции
- Рекурсия и сложные алгоритмы
- Компиляция в байткод и выполнение на виртуальной машине

## Архитектура системы

### Clean Architecture
Проект следует принципам Clean Architecture с четким разделением слоев:

- **Domain/**: Языковые конструкции и AST (C++20)
- **Application/**: Компилятор, байткод, VM, оптимизатор (C++20)
- **Infrastructure/**: Сеть, ORM, нативные интеграции (C++/.NET)
- **Presentation/**: CLI, LSP, VS Code, инструменты (TypeScript/C++)

### Сборка и развертывание
- **CMake Presets**: dev, release конфигурации
- **Готовые скрипты**: smoke-тесты, CI автоматизация
- **Кросс-платформенная поддержка**: Windows, Linux, macOS

## Ядро языка и рантайм

### Лексический и синтаксический анализ
- **Лексер/Парсер** (C++20) с структурной диагностикой
- **JSON диагностика**: `{message, line, col}` формат
- **Рекурсивный нисходящий парсер** с поддержкой ошибок

### Компиляция и выполнение
- **Компилятор** → генерация байткода
- **Стековая VM** с кадрами вызовов
- **Оптимизации**: constant folding, dead code elimination, tail-call optimization

### Языковые возможности
- **Типы**: i32, i64, строки, булевы значения
- **Контрольные конструкции**: if/else, циклы
- **Функции**: параметры, возвращаемые значения, рекурсия
- **Массивы**: через builtin-функции arr_new/arr_get/arr_set

### Оптимизации
- **Constant folding**: простые арифметические операции и сравнения
- **Dead Code Elimination (DCE)**: удаление недостижимого кода
- **Tail-call optimization**: оптимизация хвостовой рекурсии
- **Peephole оптимизации**: 
  - POP перед RET → NOP
  - JMP на следующую инструкцию → NOPW
- **Inline-locals**: быстрые опкоды LD0..LD3/ST0..ST3 и LOAD/STORE_LOCAL8

## Инструменты разработчика

### CLI инструменты
```bash
mplx --run file.mplx          # Выполнение кода (интерпретатор или JIT)
mplx --check file.mplx        # Проверка синтаксиса
mplx --symbols file.mplx      # Извлечение символов
mplx --bench file.mplx        # Бенчмарки (--mode, --runs, --json)
mplx --help                   # Справка
mplx --version                # Версия

# Ключевые флаги выполнения
  --jit on|off|auto           # Режим JIT (по умолчанию: auto)
  --jit-verify                # Сравнить интерпретатор и JIT, код выхода 3 при расхождении
  --hot N                     # Порог «нагрева» функции для JIT
  --trace [--trace-limit N]   # Пошаговый трейс VM/JIT
  --out path [--no-runfile]   # Куда писать числовой результат выполнения
```

#### Поведение `--run`
- Всегда печатает в stdout строку `Result: <число>`.
- Если не указан `--no-runfile`, пишет только число в файл:
  - по умолчанию `run.txt` рядом с входным файлом;
  - либо путь из `--out`.
- Запись файла выполняется до любого `return`, включая ветви `--jit-verify` и обработку ошибок.

### Бенчмарки
- **compile-run**: полный цикл компиляции и выполнения (по умолчанию)
- **run-only**: только выполнение заранее скомпилированного байткода
- **JSON формат**: для автоматической обработки результатов

Примеры:
```bash
# Средний, лучший и худший времена за 20 прогонов (JSON)
mplx --bench Presentation/examples/sum_1_to_n.mplx --mode compile-run --runs 20 --json

# Только прогон байткода, JIT отключён
mplx --bench Presentation/examples/loop.mplx --mode run-only --runs 50 --jit off --json
```

Интерпретатор и JIT можно сравнить опцией `--jit-verify` при обычном запуске:
```bash
mplx --run --jit on --jit-verify Presentation/examples/simple_sum.mplx
```
При несовпадении результатов выводится диагностическое сообщение, процесс завершится кодом 3, а файл результата всё равно будет записан (если не указан `--no-runfile`).

## JIT: модель и гарантии

- JIT работает поверх байткода VM: «горячие» функции компилируются в машинный код по порогу `--hot N`.
- Режимы:
  - `off` — только интерпретатор;
  - `on` — JIT принудительно включён;
  - `auto` — JIT включается для «горячих» функций по счётчику вызовов.
- `--jit-verify` запускает функцию в двух режимах (интерпретатор и JIT) и сравнивает результат.
- При ошибке JIT (например, невозможность финализации переходов) выполняется фолбэк на интерпретатор; CLI остаётся стабильным и возвращает корректный код завершения. Трассировку (`--trace`) и лимит (`--trace-limit`) можно использовать на обоих путях для воспроизводимости.

### LSP сервер и VS Code расширение
- **Диагностика** с точными позициями ошибок
- **Go-to-definition** и **References** с учетом скоупов
- **Hover** информация и **Signature Help**
- **Rename (F2)** для функций, переменных и параметров
- **Конфигурация**: mplx.cliPath для настройки пути к исполняемому файлу

## Интеграции

### .NET интеграция
- **C API** (mplx_native.dll) для нативных вызовов
- **P/Invoke обертка** Mplx.DotNet
- **NuGet пакет** с native assets и buildTransitive таргетом
- **Автоматическое копирование** DLL/so/dylib в выходную папку

### Сетевая инфраструктура
- **TCP сервер** mplx-net --serve
- **Бинарный фрейминг** с varint кодированием
- **Протоколы**: Echo, PING (0x01), HEALTH (0x02)
- **JSON ответы** с service/version/uptime_sec
- **Клиент** mplx-netclient с --send, --ping, --health

### ORM-лайт (SQLite)
- **Db/Stmt** классы для работы с базой данных
- **bind/get** методы для параметризованных запросов
- **Транзакции** и **query(...)** поддержка
- **LRU кэш** prepared statements
- **upsert(...)** операции

## Используемые технологии

### C++20 - Ядро системы
- **Назначение**: Компилятор, виртуальная машина, CLI инструменты
- **Причины выбора**: Высокая производительность, контроль над памятью, стандарт в системном программировании
- **Компоненты**: Lexer, Parser, Bytecode Compiler, Stack-based VM

### TypeScript/Node.js - IDE интеграция
- **Назначение**: Language Server Protocol, VS Code extension
- **Причины выбора**: Нативная поддержка VS Code, современная экосистема веб-разработки
- **Компоненты**: LSP сервер, синтаксический анализатор, диагностика ошибок

### C#/.NET 8.0 - Enterprise интеграция
- **Назначение**: .NET wrapper, межъязыковая интеграция
- **Причины выбора**: Широкая распространенность в enterprise среде, P/Invoke возможности
- **Компоненты**: Нативная DLL интеграция, runtime wrapper

### CMake - Система сборки
- **Назначение**: Кросс-платформенная сборка, управление зависимостями
- **Причины выбора**: Индустриальный стандарт для C++ проектов

### PowerShell - Автоматизация
- **Назначение**: Скрипты сборки и развертывания
- **Причины выбора**: Нативная поддержка Windows, интеграция с .NET

## Архитектура системы

```
mplx/
├── Domain/              # Языковые конструкции (C++20)
├── Application/         # Компилятор и VM (C++20)
├── Infrastructure/      # Интеграции (.NET, C++)
├── Presentation/        # UI и CLI (TypeScript, C++)
└── scripts/             # Скрипты сборки (PowerShell)
```

## Быстрый старт

### Требования
- Windows 10/11
- Visual Studio 2019+ или MSVC Build Tools
- Node.js 18+
- .NET 8.0 SDK

### Установка и сборка

```powershell
# 1. Настройка окружения
.\scripts\bootstrap-mplx.ps1

# 2. Добавление компонентов  
.\scripts\extend-mplx.ps1

# 3. Сборка DLL для .NET интеграции
.\scripts\build-simple-dll.ps1
```

### Быстрый запуск для ревьюера
```bash
# CMake presets (dev)
cmake --preset dev
cmake --build --preset dev
ctest --test-dir build/dev -C RelWithDebInfo --output-on-failure

# CLI тестирование
build/dev/Presentation/tools/mplx/mplx --check examples/hello.mplx
build/dev/Presentation/tools/mplx/mplx --bench examples/hello.mplx --mode compile-run --runs 20 --json

# Сетевая инфраструктура
build/dev/Presentation/tools/mplx-net/mplx-net --serve 127.0.0.1 5000
build/dev/Presentation/tools/mplx-netclient/mplx-netclient --ping 127.0.0.1 5000
build/dev/Presentation/tools/mplx-netclient/mplx-netclient --health 127.0.0.1 5000

# VS Code интеграция
cd Presentation/Mplx.Lsp && npm i && npm run build
cd ../vscode-mplx && npm i && npm run build
```

## Использование

### CLI инструменты
```bash
# Проверка синтаксиса
mplx --check file.mplx

# Извлечение символов
mplx --symbols file.mplx

# Выполнение кода
mplx --run file.mplx
```

### .NET интеграция
```csharp
using Mplx.DotNet;

var result = MplxRuntime.RunFromSource(source, "main");
var diagnostics = MplxRuntime.CheckSource(source);
```

### VS Code поддержка
- Синтаксическая подсветка
- Автодополнение
- Диагностика ошибок
- Навигация по коду

## Примеры кода

### Простая программа
```mplx
fn main() -> i32 {
    let x = 2;
    let y = 4;
    return x + y;
}
```

### Рекурсивная функция
```mplx
fn fibonacci(n: i32) -> i32 {
    if (n <= 1) {
        return n;
    } else {
        return fibonacci(n - 1) + fibonacci(n - 2);
    }
}

fn main() -> i32 {
    return fibonacci(10);
}
```

## Технические детали

### Компиляция
- Лексический анализ с поддержкой ключевых слов и операторов
- Рекурсивный нисходящий парсер
- Генерация байткода с оптимизациями
- Виртуальная машина со стековой архитектурой

### Интеграции
- **C API**: Нативная библиотека для межъязыкового взаимодействия
- **P/Invoke**: .NET интеграция через нативные вызовы
- **LSP**: Language Server Protocol для IDE поддержки
- **VS Code Extension**: Полноценная поддержка разработки

### Производительность
- Компиляция: < 100ms для типичных файлов
- Выполнение: Нативная скорость виртуальной машины
- Память: Минимальное потребление благодаря C++

## Тестирование

### Unit тесты
- Лексер, парсер, VM компоненты
- CRUD операции для ORM
- Транзакции и сетевые протоколы

### Интеграционные тесты
- Полный цикл компиляции и выполнения
- .NET интеграция
- LSP сервер

### Smoke тесты
- Автоматизированные скрипты проверки
- CI/CD интеграция

## Разработка

### Структура кода
- Модульная архитектура
- Четкое разделение ответственности
- Современные C++20 возможности
- TypeScript с строгой типизацией

### Репозиторий
- **История по правилам**: фичи в feature/*, инфраструктура в chore/*
- **Merge стратегия**: --no-ff для сохранения истории
- **Релизы**: семантическое версионирование v0.2.0+
- **Скрипты**: stepN-apply.ps1, local-ci.ps1, smoke-тесты

### Документация
- Подробные комментарии в коде
- API документация
- Примеры использования

